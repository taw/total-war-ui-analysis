#!/usr/bin/env ruby

require_relative "../lib/task_set"

task_set = TaskSet.new(*ARGV)
task_set.todo.select!{|todo| todo.unpacked_path.exist?}

converter_path = Pathname(__dir__) + "xml2ui"

# In 4 threads
cores = 4
cores.times.map{|i|
  Thread.new{
    while true
      todo = task_set.todo.shift or break

      todo.recreated_path.parent.mkpath

      ok = system %Q[#{converter_path} "#{todo.unpacked_path}" "#{todo.recreated_path}"]
      if !ok
        puts "ERR:  #{todo.data_path}"
      elsif todo.data_path.read == todo.recreated_path.read
        puts "OK:   #{todo.data_path}"
      else
        puts "DIFF: #{todo.data_path} #{todo.unpacked_path} #{todo.recreated_path}"
      end
    end
  }
}.map(&:join)
