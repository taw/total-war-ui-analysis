#!/usr/bin/env ruby

require "pathname"

data_dir = Pathname("#{__dir__}") + "../data"
output_dir = Pathname("#{__dir__}") + "../output"

if ARGV.empty?
  todo = data_dir.find.reject(&:directory?)
else
  todo = ARGV.map{|path| Pathname(path).realpath}
end

# In 4 threads
cores = 4
cores.times.map{|i|
  Thread.new{
    while true
      path = todo.shift or break
      magic = path.read(10)
      next unless magic =~ /\AVersion(\d\d\d)\z/
      version = $1
      game_name = path.dirname.basename.to_s
      file_name = path.basename.to_s
      output_path = output_dir + version + "#{game_name}-#{file_name}.txt"

      output_path.parent.mkpath
      puts "#{i} #{path}"
      system %Q[#{__dir__}/analysis "#{path}" >"#{output_path}"]
    end
  }
}.map(&:join)
